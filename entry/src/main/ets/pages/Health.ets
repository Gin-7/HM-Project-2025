import { AccountComponent } from '../components/user/AccountComponent'
import {AdSwiper} from '../components/common/AdSwiper'
import {PostCard} from '../components/common/PostCard'
import {PostItem,AdItem, GlobalUserInfo, HealthData } from '../types/Types'
import {CreatePostPage} from '../components/common/CreatePostPage'
import {ServicePage} from './ServicePage'
import { AppStorageV2 } from '@kit.ArkUI'
import { HealthRes, StepsRes, SessionRes, MessageReq, MessageRes } from '../api/types'
import HealthUtils from '../utils/HealthUtils'
import AIUtils from '../utils/AIUtils'
import MockUtils from '../utils/MockUtils'
import CommonUtils from '../utils/CommonUtils'


let userInfo: GlobalUserInfo = AppStorageV2.connect(GlobalUserInfo, 'globalUserInfo', () => new GlobalUserInfo())!

interface stateItem {
  label: string,
  value: number,
  target?: number,
  color?: string
}

@Builder
export function HealthBuilder() {
  Health()
}

@Preview
@Component
struct Health {
  pathStack: NavPathStack = new NavPathStack()
  today: Date = new Date();
  dayOfWeek: number = this.today.getDay();

  healthRcd: HealthRes | null = null;
  weeklySteps: StepsRes[] | null = null;
  mock: Boolean = false;
  @State states: stateItem[] = [];
  @State body: stateItem[] = [];

  @State showWeeklySteps: boolean = false;
  toggleShowWeeklySteps = () => {
    this.showWeeklySteps = !this.showWeeklySteps;
  }

  @State aiSuggestion: string = '';
  @State isAiLoading: boolean = false;
  @State showAiResult: boolean = false;
  @State session: SessionRes | null = null

  private async fetchLatestHealthRecord() {
    this.healthRcd = await HealthUtils.getRcdLatest(userInfo.userId);
  }
  private async fetchStepsLastWeek() {
    this.weeklySteps = await HealthUtils.getSteps(userInfo.userId);
  }

  private buildHealthInquiryText(health: HealthRes): string {
    return `
${health.recordDate}ï¼Œæˆ‘çš„å¥åº·æ•°æ®å¦‚ä¸‹ï¼š
- è¡€æ°§ï¼š${health.bloodOxygen}%
- è¡€åŽ‹ï¼š${health.systolicBp}/${health.diastolicBp} mmHg
- è¡€ç³–ï¼š${health.bloodGlucose} mmol/L
- å¿ƒçŽ‡ï¼š${health.heartRate} æ¬¡/åˆ†é’Ÿ
- ä½“é‡ï¼š${health.weight} kgï¼Œèº«é«˜ï¼š${health.height} cm
- ç¡çœ ï¼šæ€»å…± ${health.sleepDuration} å°æ—¶ï¼ˆæ·±ç¡ ${health.deepSleep}hï¼Œæµ…ç¡ ${health.lightSleep}hï¼‰
- æ­¥æ•°ï¼š${health.steps} æ­¥
- åŽ‹åŠ›æ°´å¹³ï¼š${health.stressLevel}/100
- æ´»åŠ›æŒ‡æ•°ï¼š${health.vitality}/100

è¯·æ ¹æ®ä»¥ä¸Šæ•°æ®ï¼Œç»™æˆ‘ä¸€äº›å¥åº·å»ºè®®ï¼Œæ¯”å¦‚é¥®é£Ÿã€è¿åŠ¨ã€ç¡çœ æˆ–æ˜¯å¦éœ€è¦å°±åŒ»ã€‚
`.trim().replace(/\n\s+/g, '\n'); // æ¸…ç†å¤šä½™ç©ºæ ¼
  }

  private async fetchAiSuggestion() {
    if (!this.healthRcd) return;
    this.isAiLoading = true;
    this.aiSuggestion = 'æ­£åœ¨åˆ†æžæ‚¨çš„å¥åº·æ•°æ®...';
    this.showAiResult = true;
    this.session = await AIUtils.createSession(userInfo.userId)
    await AIUtils.sendMessageAndWaitAI(
      this.session!.id,
      this.buildHealthInquiryText(this.healthRcd),
      (messages) => {
        // å®žæ—¶æ›´æ–°èŠå¤©ç•Œé¢
        this.aiSuggestion = messages[-1].text;
      }
    );
    this.isAiLoading = false;
  }

  async aboutToAppear() {
    await this.fetchLatestHealthRecord();
    if (this.healthRcd == null) {
      this.mock = true
      this.healthRcd = MockUtils.mockHealthRecord()
    }
    await this.fetchStepsLastWeek();
    if (this.weeklySteps == null) {
      this.mock = true
      this.weeklySteps = MockUtils.mockWeeklySteps()
    }
    this.states = [
      { label: 'æ­¥æ•°', value: this.healthRcd.steps, target: this.healthRcd.steps + 8000, color: '#FF6B6B' },
      { label: 'ç¡çœ æ—¶é•¿', value: this.healthRcd.sleepDuration, target: this.healthRcd.sleepDuration + 1, color: '#FF6B6B' }
    ]
    this.body = [
      { label: "ä½“é‡(kg)", value: this.healthRcd.weight },
      { label: "èº«é«˜(cm)", value: this.healthRcd.height },
      { label: "å¿ƒçŽ‡(æ¬¡/åˆ†)", value: this.healthRcd.heartRate },
      { label: "è¡€æ°§(%)", value: this.healthRcd.bloodOxygen },
      { label: "è¡€ç³–(mmol/L)", value: this.healthRcd.bloodGlucose },
      { label: "ç¡çœ (å°æ—¶)", value: this.healthRcd.sleepDuration },
      { label: "æ·±åº¦ç¡çœ (å°æ—¶)", value: this.healthRcd.deepSleep },
      { label: "æµ…åº¦ç¡çœ (å°æ—¶)", value: this.healthRcd.lightSleep },
      { label: "æ”¶ç¼©åŽ‹ (mmHg)", value: this.healthRcd.systolicBp },
      { label: "èˆ’å¼ åŽ‹ (mmHg)", value: this.healthRcd.diastolicBp },
      { label: "åŽ‹åŠ›æ°´å¹³ (0-100)", value: this.healthRcd.stressLevel },
      { label: "æ´»åŠ›å€¼ (0-100)", value: this.healthRcd.vitality },
    ]
  }


  build() {
    NavDestination() {
      // æ ‡é¢˜
      Stack({ alignContent: Alignment.Start }) {
        Text("ä¸ªäººå¥åº·çœ‹æ¿")
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .width('100%')
          .textAlign(TextAlign.Center)
        Text('â†')
          .fontSize(20)
          .fontColor('#007DFF')
          .onClick(() => {
            this.pathStack.pop()
          })
      }.width('100%').backgroundColor(Color.White).padding(16)

      Scroll() {
        Column() {
          // ç¬¬ä¸€éƒ¨åˆ†ï¼šè¿åŠ¨æ•°æ®ï¼ˆè¿›åº¦æ¡+æ•°å­—ï¼‰
          Column() {
            Text(`${this.healthRcd!.recordDate} ${CommonUtils.getWeekdayCN(this.healthRcd!.recordDate)}`)
              .fontSize(16)
              .fontColor('#333')
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 16 }) // æ·»åŠ ä¸€äº›åº•éƒ¨é—´è·ä»¥åŒºåˆ†å†…å®¹

            ForEach(this.states, (item: stateItem, index: number) => {
              Row() {
                Text(item.label)
                  .width('25%')
                  .fontSize(16)
                  .fontColor('#333')
                  .textAlign(TextAlign.Start)

                Progress({ value: item.value, total: item.target, type: ProgressType.Linear })
                  .width('50%')
                  .style({ strokeWidth: 12 })

                // æ•°å€¼ï¼šå½“å‰/ç›®æ ‡
                Text(`${item.value}`)   // Text(`${item.value}/${item.target}`)
                  .fontSize(14)
                  .fontColor('#666')
                  .fontWeight(FontWeight.Bold)
                  .textAlign(TextAlign.End)
                  .width('25%')
              }
              .width('100%')
              .padding({ top: 8, bottom: 8 })
              .alignItems(VerticalAlign.Center)
            })

            if (this.showWeeklySteps) {
              Row() {
                ForEach(this.weeklySteps, (item: StepsRes, index: number) => {
                  Column() {
                    Text(item.date)
                      .width('75%')
                      .fontSize(10)
                      .fontColor('#333')
                      .textAlign(TextAlign.Center)

                    Progress({ value: item.steps, total: item.steps + 8000, type: ProgressType.Ring })
                      .width('80%')
                      .style({ strokeWidth: 6 })
                      .margin({ top: 2, bottom: 2 })

                    Text(`${item.steps}æ­¥`)
                      .fontSize(10)
                      .fontColor('#666')
                      .fontWeight(FontWeight.Bold)
                      .textAlign(TextAlign.Center)
                  }
                  .layoutWeight(1) // å‡åˆ†çˆ¶å®¹å™¨å®½åº¦
                  .alignItems(HorizontalAlign.Center)
                })
              }
              .width('100%')
              .margin({ top: 4, bottom: 4 })
              .padding(4)
              .backgroundColor('#ffffffff')
              .borderRadius(24)
            }

            Row() {
              Text(this.showWeeklySteps ? 'æ”¶èµ·' : 'è¿‡åŽ»ä¸€å‘¨')
                .fontSize(12)
                .fontColor('#6e6e6e')

              Text(this.showWeeklySteps ? '\u25B2' : '\u25BC')
                .fontSize(10) // å¯ç•¥å°ä¸€ç‚¹
                .fontColor('#6e6e6e')
                .margin({ left: 4 })
            }
            .width('100%')
            .justifyContent(FlexAlign.End)
            .margin({ right: 4 })
            .onClick(() => this.toggleShowWeeklySteps())
          }
          .width('90%')
          .margin({ top: 16 })
          .padding(12)
          .backgroundColor('#ffffffff')
          .borderRadius(24)

          // ç¬¬äºŒéƒ¨åˆ†ï¼šç”Ÿç†æŒ‡æ ‡ï¼ˆå¡ç‰‡ç½‘æ ¼ï¼‰
          Column() {
            Text("ç”Ÿç†æŒ‡æ ‡").fontSize(18).fontWeight(FontWeight.Bold).width('100%');
            Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceBetween }) {
              ForEach(this.body, (item: stateItem) => {
                // æŒ‡æ ‡å¡ç‰‡
                Column({ space: 5 }) {
                  Text(item.label).fontSize(14).fontColor("#999").margin({ bottom: 4 });
                  Text(`${item.value}`).fontSize(16).fontWeight(FontWeight.Bold);
                }
                .width('46%')
                .margin(4)
                .padding({ top: 8, bottom: 8 })
                .backgroundColor("#FFFFFF")
                .borderRadius(8)
              })
            }
            .margin({ top: 8 })
          }
          .width('90%')
          .margin({ top: 16 })
          .padding({ top: 16, bottom: 16, left: 8, right: 8 })
          .backgroundColor('#ffffffff')
          .borderRadius(24)

          // ç¬¬ä¸‰éƒ¨åˆ†ï¼šai
          Column() {
            Button('ðŸ’¡ èŽ·å– AI å¥åº·å»ºè®®')
              .width('80%')
              .height(40)
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#007DFF')
              .borderRadius(20)
              .onClick(() => {
                this.fetchAiSuggestion();
              })

            if (this.showAiResult) {
              Divider().margin(16)
              Column() {
                if (this.isAiLoading) {
                  LoadingProgress()
                    .width(30)
                    .height(30)
                    .color('#007DFF')
                }
                Text(this.aiSuggestion)
                  .fontSize(15)
                  .fontColor('#333')
                  .textAlign(TextAlign.Center)
                  .padding(16)
                  .backgroundColor('#F9F9FF')
                  .borderRadius(12)
                  .width('100%')
              }
              .width('90%')
              .margin({ top: 8, bottom: 8 })
            }
          }
          .width('100%')
          .margin({ top: 24, bottom: 24 })
          .padding({ bottom: 24 })
        }
        .width('100%')
        .backgroundColor('#F5F5F5')
      }
      .scrollable(ScrollDirection.Vertical)
      .width('100%')
      .height('100%')
    }
    .onReady((context: NavDestinationContext) => {
      this.pathStack = context.pathStack
    })
    .hideTitleBar(true)
  }

}
