// pages/ExerciseRecord.ets
import { axiosAPI } from '../utils/BaseRequest';
import prompt from '@ohos.promptAction';
import { AppStorageV2 } from '@kit.ArkUI';
import { Exercise } from '../types/exercise'

interface ApiResponse<T> {
  code: number
  msg: string
  data?: T
}

@Builder
export function ExerciseRecordBuilder() {
  ExerciseRecord()
}

@Preview
@Component
struct ExerciseRecord {
  pathStack: NavPathStack = new NavPathStack()

  @State records: Exercise[] = []
  @State isLoading: boolean = false

  // ËøêÂä®Á±ªÂûãÊòæÁ§∫ÂêçÁß∞Êò†Â∞Ñ
  private exerciseTypeNames: Record<string, string> = {
    'RUNNING': 'Ë∑ëÊ≠•',
    'WALKING': 'Ê≠•Ë°å',
    'SWIMMING': 'Ê∏∏Ê≥≥',
    'CYCLING': 'È™ëË°å',
    'OTHER': 'ÂÖ∂‰ªñ'
  }

  // Âº∫Â∫¶Á≠âÁ∫ßÊòæÁ§∫ÂêçÁß∞Êò†Â∞Ñ
  private intensityLevelNames: Record<string, string> = {
    'LOW': '‰ΩéÂº∫Â∫¶',
    'MODERATE': '‰∏≠Á≠âÂº∫Â∫¶',
    'HIGH': 'È´òÂº∫Â∫¶'
  }

  // Ëé∑ÂèñÂº∫Â∫¶È¢úËâ≤
  private getIntensityColor(level: string): string {
    const colors: Record<string, string> = {
      'LOW': '#52C41A',
      'MODERATE': '#FAAD14',
      'HIGH': '#F5222D'
    }
    return colors[level] || '#666666'
  }

  // Ëé∑ÂèñÂõæÊ†á
  private getExerciseIcon(type: string): string {
    const icons: Record<string, string> = {
      'RUNNING': 'üèÉ',
      'WALKING': 'üö∂',
      'SWIMMING': 'üèä',
      'CYCLING': 'üö¥',
      'OTHER': 'üèÖ'
    }
    return icons[type] || 'üèÖ'
  }

  aboutToAppear() {
    this.loadRecords()
  }

  build() {
    NavDestination() {
      Column() {
        // È°∂ÈÉ®ÂØºËà™Ê†è
        Row() {
          Text('‚Üê')
            .fontSize(20)
            .fontColor('#007DFF')
            .onClick(() => {
              this.pathStack.pop()
            })

          Text('ËøêÂä®ËÆ∞ÂΩï')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ left: 12 })
            .layoutWeight(1)
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#FFFFFF')
        .alignItems(VerticalAlign.Center)
        .zIndex(1)

        // ËÆ∞ÂΩïÂàóË°®Âå∫Âüü
        Column() {
          if (this.isLoading && this.records.length === 0) {
            // Âä†ËΩΩ‰∏≠
            Column() {
              LoadingProgress()
                .width(40)
                .height(40)
                .color('#007DFF')

              Text('Âä†ËΩΩ‰∏≠...')
                .fontSize(14)
                .fontColor('#999999')
                .margin({ top: 12 })
            }
            .width('100%')
            .height(400)
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
          } else if (this.records.length === 0) {
            // Á©∫Áä∂ÊÄÅ
            Column() {
              Text('ÊöÇÊó†ËøêÂä®ËÆ∞ÂΩï')
                .fontSize(16)
                .fontColor('#666666')
                .margin({ bottom: 8 })

              Text('ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†Á¨¨‰∏ÄÊù°ËÆ∞ÂΩï')
                .fontSize(14)
                .fontColor('#999999')
            }
            .width('100%')
            .height(400)
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
          } else {
            // ËÆ∞ÂΩïÂàóË°®
            Scroll() {
              Column() {
                ForEach(this.records, (record: Exercise) => {
                  this.buildRecordItem(record)
                })
              }
              .width('100%')
              .padding({ top: 8, bottom: 80 }) // ‰∏∫Â∫ïÈÉ®ÊåâÈíÆÁïôÂá∫Á©∫Èó¥
            }
            .scrollable(ScrollDirection.Vertical)
            .scrollBar(BarState.Off)
          }
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor('#F5F5F5')

        // Â∫ïÈÉ®Âõ∫ÂÆöÊ∑ªÂä†ÊåâÈíÆ
        Column() {
          Button('+ Ê∑ªÂä†ËøêÂä®ËÆ∞ÂΩï', { type: ButtonType.Normal })
            .width('100%')
            .height(56)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
            .backgroundColor('#007DFF')
            .borderRadius(0)
            .onClick(() => {
              // Ë∑≥ËΩ¨Âà∞ÂàõÂª∫È°µÈù¢ - ‰ΩøÁî® pathStack
              this.pathStack.pushPathByName('CreateExerciseRecord', null, false)
            })
        }
        .width('100%')
        .backgroundColor('#FFFFFF')
        .shadow({
          radius: 8,
          color: '#1A000000',
          offsetX: 0,
          offsetY: -2
        })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')
    }
    .onReady((context: NavDestinationContext) => {
      this.pathStack = context.pathStack
    })
    .onResult(() => {
      this.loadRecords()
    })
    .hideTitleBar(true)
  }

  @Builder
  buildRecordItem(record: Exercise) {
    Column() {
      Row() {
        // Â∑¶‰æßÔºöÂõæÊ†á
        Column() {
          Text(this.getExerciseIcon(record.exerciseType))
            .fontSize(24)
        }
        .width(48)
        .height(48)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#F0F8FF')
        .borderRadius(24)

        // ‰∏≠Èó¥Ôºö‰ø°ÊÅØ
        Column() {
          Row() {
            Text(this.exerciseTypeNames[record.exerciseType] || record.exerciseType)
              .fontSize(16)
              .fontColor('#333333')
              .fontWeight(FontWeight.Medium)
              .layoutWeight(1)

            if (record.caloriesBurned) {
              Text(`${record.caloriesBurned} kcal`)
                .fontSize(14)
                .fontColor('#FF6B6B')
                .fontWeight(FontWeight.Medium)
            }
          }
          .width('100%')
          .margin({ bottom: 4 })

          Row() {
            Text(`${record.durationMinutes}ÂàÜÈíü`)
              .fontSize(14)
              .fontColor('#666666')

            Blank()

            Text(this.intensityLevelNames[record.intensityLevel!] || record.intensityLevel)
              .fontSize(12)
              .fontColor('#FFFFFF')
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .backgroundColor(this.getIntensityColor(record.intensityLevel!))
              .borderRadius(4)
          }
          .width('100%')

          Text(record.recordDate)
            .fontSize(12)
            .fontColor('#999999')
            .margin({ top: 4 })
            .width('100%')
        }
        .margin({ left: 12 })
        .layoutWeight(1)
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .margin({ bottom: 8, left: 12, right: 12 })
    .borderRadius(12)
    .shadow({
      radius: 2,
      color: '#0A000000',
      offsetX: 0,
      offsetY: 1
    })
  }

  // Âä†ËΩΩËÆ∞ÂΩï
  private async loadRecords() {
    this.isLoading = true

    try {
      const userId = 1 // TODO: ‰ªéAppStorageËé∑Âèñ
      const response: ApiResponse<Exercise[]> = await axiosAPI.get(`api/exercise/last-n-days?userId=${userId}&days=${7}`)

      if (response.code === 200 && response.data) {
        // ÊåâÊó•ÊúüÂÄíÂ∫èÊéíÂàóÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢Ôºâ
        this.records = response.data.sort((a, b) =>
        new Date(b.recordDate).getTime() - new Date(a.recordDate).getTime()
        )
      } else {
        prompt.showToast({
          message: response.msg || 'Âä†ËΩΩÂ§±Ë¥•',
          duration: 2000
        })
      }
    } catch (error) {
      console.error('Âä†ËΩΩÂºÇÂ∏∏:', error)
    } finally {
      this.isLoading = false
    }
  }
}