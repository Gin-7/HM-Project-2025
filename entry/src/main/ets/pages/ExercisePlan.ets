// pages/ExercisePlan.ets
import { axiosAPI } from '../utils/BaseRequest';
import prompt from '@ohos.promptAction';
import { AppStorageV2 } from '@kit.ArkUI';
import { GlobalUserInfo } from '../types/Types'
let userInfo: GlobalUserInfo = AppStorageV2.connect(GlobalUserInfo, 'globalUserInfo', () => new GlobalUserInfo())!

// è¿åŠ¨è®¡åˆ’æ¥å£
interface ExercisePlanItem {
  id: number
  userId: number
  startDate: string
  endDate: string
  startTime?: string
  endTime?: string
  eventContent?: string
  weeklyPlanId?: number
  remark?: string
  completionStatus: number
  createdAt: string
  updatedAt: string
}

interface ApiResponse<T> {
  code: number
  message: string
  data?: T
}

@Builder
export function ExercisePlanBuilder() {
  ExercisePlan()
}

@Preview
@Component
struct ExercisePlan {
  pathStack: NavPathStack = new NavPathStack()

  @State plans: ExercisePlanItem[] = []
  @State isLoading: boolean = false
  @State showDeleteConfirm: boolean = false
  @State deletingPlanId: number = 0

  // å®ŒæˆçŠ¶æ€æ˜¾ç¤ºåç§°æ˜ å°„
  private completionStatusNames: Record<number, string> = {
    0: 'æœªå®Œæˆ',
    1: 'å·²å®Œæˆ'
  }

  // å®ŒæˆçŠ¶æ€é¢œè‰²
  private getCompletionColor(status: number): string {
    return status === 1 ? '#52C41A' : '#FAAD14'
  }

  // è·å–äº‹ä»¶å›¾æ ‡
  private getEventIcon(content?: string): string {
    if (!content) return 'ğŸ“…'

    const contentLower = content.toLowerCase()
    if (contentLower.includes('è·‘æ­¥') || contentLower.includes('è·‘')) return 'ğŸƒ'
    if (contentLower.includes('æ¸¸æ³³') || contentLower.includes('æ³³')) return 'ğŸŠ'
    if (contentLower.includes('éª‘è¡Œ') || contentLower.includes('éª‘')) return 'ğŸš´'
    if (contentLower.includes('æ­¥è¡Œ') || contentLower.includes('èµ°')) return 'ğŸš¶'
    if (contentLower.includes('å¥èº«') || contentLower.includes('é”»ç‚¼')) return 'ğŸ’ª'
    if (contentLower.includes('ç‘œä¼½') || contentLower.includes('æ‹‰ä¼¸')) return 'ğŸ§˜'
    return 'ğŸ“…'
  }

  aboutToAppear() {
    this.loadPlans()
  }

  build() {
    NavDestination() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Text('â†')
            .fontSize(20)
            .fontColor('#007DFF')
            .onClick(() => {
              this.pathStack.pop()
            })

          Text('è¿åŠ¨è®¡åˆ’')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ left: 12 })
            .layoutWeight(1)
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#FFFFFF')
        .alignItems(VerticalAlign.Center)
        .zIndex(1)

        // ç§»é™¤äº†è¿‡æ»¤é€‰é¡¹

        // è®¡åˆ’åˆ—è¡¨åŒºåŸŸ
        Column() {
          if (this.isLoading && (!this.plans || this.plans.length === 0)) {
            // åŠ è½½ä¸­
            Column() {
              LoadingProgress()
                .width(40)
                .height(40)
                .color('#007DFF')

              Text('åŠ è½½ä¸­...')
                .fontSize(14)
                .fontColor('#999999')
                .margin({ top: 12 })
            }
            .width('100%')
            .height(400)
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
          } else if (!this.plans || this.plans.length === 0) {
            // ç©ºçŠ¶æ€
            Column() {
              Text('æš‚æ— è¿åŠ¨è®¡åˆ’')
                .fontSize(16)
                .fontColor('#666666')
                .margin({ bottom: 8 })

              Text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªè®¡åˆ’')
                .fontSize(14)
                .fontColor('#999999')
            }
            .width('100%')
            .height(400)
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
          } else {
            // è®¡åˆ’åˆ—è¡¨
            Scroll() {
              Column() {
                if (this.plans && this.plans.length > 0) {
                  ForEach(this.plans, (plan: ExercisePlanItem) => {
                    this.buildPlanItem(plan)
                  })
                }
              }
              .width('100%')
              .padding({ top: 8, bottom: 80 })
            }
            .scrollable(ScrollDirection.Vertical)
            .scrollBar(BarState.Off)
          }
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor('#F5F5F5')

        // åº•éƒ¨å›ºå®šæ·»åŠ æŒ‰é’®
        Column() {
          Button('+ æ·»åŠ è¿åŠ¨è®¡åˆ’', { type: ButtonType.Normal })
            .width('100%')
            .height(56)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
            .backgroundColor('#007DFF')
            .borderRadius(0)
            .onClick(() => {
              this.pathStack.pushPathByName('CreateExercisePlan', null, false)
            })
        }
        .width('100%')
        .backgroundColor('#FFFFFF')
        .shadow({
          radius: 8,
          color: '#1A000000',
          offsetX: 0,
          offsetY: -2
        })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')
    }
    .onReady((context: NavDestinationContext) => {
      this.pathStack = context.pathStack
    })
    .onResult(() => {
      this.loadPlans()
    })
    .hideTitleBar(true)
  }

  @Builder
  buildPlanItem(plan: ExercisePlanItem) {
    Column() {
      Row() {
        // å·¦ä¾§ï¼šå›¾æ ‡å’ŒçŠ¶æ€
        Column() {
          Column() {
            Text(this.getEventIcon(plan.eventContent))
              .fontSize(20)
          }
          .width(48)
          .height(48)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor(plan.completionStatus === 1 ? '#E6F7FF' : '#F0F8FF')
          .borderRadius(24)

          // çŠ¶æ€æŒ‡ç¤ºå™¨
          if (plan.completionStatus === 1) {
            Text('âœ“')
              .fontSize(12)
              .fontColor('#52C41A')
              .fontWeight(FontWeight.Bold)
              .margin({ top: 4 })
          }
        }
        .alignItems(HorizontalAlign.Center)

        // ä¸­é—´ï¼šä¿¡æ¯
        Column() {
          // äº‹ä»¶å†…å®¹
          Row() {
            Text(plan.eventContent || 'è¿åŠ¨è®¡åˆ’')
              .fontSize(16)
              .fontColor('#333333')
              .fontWeight(FontWeight.Medium)
              .layoutWeight(1)

            Text(this.completionStatusNames[plan.completionStatus] || 'æœªçŸ¥çŠ¶æ€')
              .fontSize(12)
              .fontColor('#FFFFFF')
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .backgroundColor(this.getCompletionColor(plan.completionStatus))
              .borderRadius(4)
          }
          .width('100%')
          .margin({ bottom: 4 })

          // æ—¥æœŸæ—¶é—´
          Row() {
            Text(`${plan.startDate}`)
              .fontSize(14)
              .fontColor('#666666')

            if (plan.startTime) {
              Text(` ${plan.startTime}`)
                .fontSize(14)
                .fontColor('#666666')
            }

            if (plan.endDate && plan.endDate !== plan.startDate) {
              Text(` è‡³ ${plan.endDate}`)
                .fontSize(14)
                .fontColor('#666666')
            }

            if (plan.endTime) {
              Text(` ${plan.endTime}`)
                .fontSize(14)
                .fontColor('#666666')
            }
          }
          .width('100%')
          .margin({ bottom: 4 })

          // å¤‡æ³¨
          if (plan.remark) {
            Text(plan.remark)
              .fontSize(12)
              .fontColor('#999999')
              .width('100%')
          }
        }
        .margin({ left: 12 })
        .layoutWeight(1)
      }
      .width('100%')

      // æ“ä½œæŒ‰é’®è¡Œ
      Row() {
        // å¦‚æœæ˜¯æœªå®ŒæˆçŠ¶æ€ï¼Œæ˜¾ç¤ºæ ‡è®°å®ŒæˆæŒ‰é’®
        if (plan.completionStatus === 0) {
          Button('æ ‡è®°å®Œæˆ', { type: ButtonType.Normal })
            .width(80)
            .height(32)
            .fontSize(12)
            .fontColor('#52C41A')
            .backgroundColor('#F6FFED')
            .border({
              width: 1,
              color: '#52C41A',
              style: BorderStyle.Solid
            })
            .onClick(() => {
              this.markAsCompleted(plan.id)
            })
            .margin({ right: 8 })
        }

        // ç¼–è¾‘æŒ‰é’®
        Button('ç¼–è¾‘', { type: ButtonType.Normal })
          .width(60)
          .height(32)
          .fontSize(12)
          .fontColor('#007DFF')
          .backgroundColor('#F0F8FF')
          .border({
            width: 1,
            color: '#007DFF',
            style: BorderStyle.Solid
          })
          .onClick(() => {
            this.editPlan(plan.id)
          })
          .margin({ right: 8 })

        // åˆ é™¤æŒ‰é’®
        Button('åˆ é™¤', { type: ButtonType.Normal })
          .width(60)
          .height(32)
          .fontSize(12)
          .fontColor('#F5222D')
          .backgroundColor('#FFF2F0')
          .border({
            width: 1,
            color: '#F5222D',
            style: BorderStyle.Solid
          })
          .onClick(() => {
            this.showDeleteConfirmDialog(plan.id)
          })

        Blank()
      }
      .width('100%')
      .margin({ top: 12 })
      .justifyContent(FlexAlign.Start)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .margin({ bottom: 8, left: 12, right: 12 })
    .borderRadius(12)
    .shadow({
      radius: 2,
      color: '#0A000000',
      offsetX: 0,
      offsetY: 1
    })
  }

  // åŠ è½½è®¡åˆ’
  private async loadPlans() {
    this.isLoading = true

    try {
      const date = new Date()
      const date7 = new Date();
      date7.setDate(date7.getDate() + 7);

      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0'); // æœˆä»½ä»0å¼€å§‹ï¼Œéœ€+1
      const day = String(date.getDate()).padStart(2, '0');

      const formattedDate = `${year}-${month}-${day}`;

      const year7 = date7.getFullYear();
      const month7 = String(date7.getMonth() + 1).padStart(2, '0'); // æœˆä»½ä»0å¼€å§‹ï¼Œéœ€+1
      const day7 = String(date7.getDate()).padStart(2, '0');

      const formattedDate7 = `${year7}-${month7}-${day7}`;
      const response: ApiResponse<ExercisePlanItem[]> = await axiosAPI.get(`/api/single-exercise-plan/weekly?userId=${userInfo.userId}&startDate=${formattedDate}&endDate=${formattedDate7}`)

      console.info('åŠ è½½è®¡åˆ’APIå“åº”:', response)

      if (response.code === 200) {
        if (response.data && Array.isArray(response.data)) {
          this.plans = response.data.sort((a, b) =>
          new Date(b.startDate).getTime() - new Date(a.startDate).getTime()
          )
        } else {
          this.plans = []
          console.warn('APIè¿”å›çš„æ•°æ®ä¸æ˜¯æ•°ç»„:', response.data)
        }
      } else {
        prompt.showToast({
          message: response.message || 'åŠ è½½å¤±è´¥',
          duration: 2000
        })
        this.plans = []
      }
    } catch (error) {
      console.error('åŠ è½½å¼‚å¸¸:', error)
      prompt.showToast({
        message: 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•',
        duration: 2000
      })
      this.plans = []
    } finally {
      this.isLoading = false
      console.info('åŠ è½½å®Œæˆï¼Œplans:', this.plans)
    }
  }

  // æ ‡è®°ä¸ºå·²å®Œæˆ
  private async markAsCompleted(planId: number) {
    try {
      const response: ApiResponse<void> = await axiosAPI.put(`/exercise/plan/${planId}/complete`)

      if (response.code === 200) {
        prompt.showToast({
          message: 'æ ‡è®°å®ŒæˆæˆåŠŸ',
          duration: 2000
        })
        this.loadPlans()
      } else {
        prompt.showToast({
          message: response.message || 'æ“ä½œå¤±è´¥',
          duration: 2000
        })
      }
    } catch (error) {
      console.error('æ“ä½œå¼‚å¸¸:', error)
      prompt.showToast({
        message: 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•',
        duration: 2000
      })
    }
  }

  // ç¼–è¾‘è®¡åˆ’
  private editPlan(planId: number) {
    prompt.showToast({
      message: 'ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­',
      duration: 2000
    })
  }

  // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
  private showDeleteConfirmDialog(planId: number) {
    this.deletingPlanId = planId
    this.showDeleteConfirm = true

    // ä½¿ç”¨è‡ªå®šä¹‰å¯¹è¯æ¡†æç¤º
    prompt.showDialog({
      title: 'ç¡®è®¤åˆ é™¤',
      message: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¿åŠ¨è®¡åˆ’å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚',
      buttons: [
        {
          text: 'å–æ¶ˆ',
          color: '#666666'
        },
        {
          text: 'åˆ é™¤',
          color: '#F5222D'
        }
      ]
    }).then((result) => {
      if (result.index === 1) { // ç‚¹å‡»äº†åˆ é™¤æŒ‰é’®
        this.deletePlan(planId)
      }
      this.showDeleteConfirm = false
    })
  }

  // åˆ é™¤è®¡åˆ’
  private async deletePlan(planId: number) {
    try {
      const response: ApiResponse<void> = await axiosAPI.delete(`/api/single-exercise-plan/delete?id=${planId}`)

      if (response.code === 200) {
        prompt.showToast({
          message: 'åˆ é™¤æˆåŠŸ',
          duration: 2000
        })
        // é‡æ–°åŠ è½½è®¡åˆ’åˆ—è¡¨
        this.loadPlans()
      } else {
        prompt.showToast({
          message: response.message || 'åˆ é™¤å¤±è´¥',
          duration: 2000
        })
      }
    } catch (error) {
      console.error('åˆ é™¤å¼‚å¸¸:', error)
      prompt.showToast({
        message: 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•',
        duration: 2000
      })
    }
  }
}